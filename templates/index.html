{% extends "base.html" %}
{% block content %}
<div class="grid">
  <div class="card kpi"><div class="muted">Active Products</div><div class="v">{{ counts.products }}</div></div>
  <div class="card kpi"><div class="muted">Warehouses</div><div class="v">{{ counts.warehouses }}</div></div>
  <div class="card kpi"><div class="muted">In-Transit Shipments</div><div class="v">{{ counts.in_transit }}</div></div>
</div>

<div class="section s-green">
  <div class="section-h"><h3 style="margin:0">Country band — Totals</h3><span class="muted">Stock / In transit / Current Daily Ad Spend (USD)</span></div>
  <div class="grid">
    {% for c in countries %}
      <div class="card">
        <div><b>{{ c.country }}</b> <span class="badge">{{ c.code }}</span></div>
        <div class="muted">Stock: {{ band[c.country].stock or 0 }}</div>
        <div class="muted">In transit: {{ band[c.country].in_transit or 0 }}</div>
        <div class="muted">Daily ad spend: ${{ band[c.country].ad_spend|round(0) }}</div>
      </div>
    {% endfor %}
  </div>
</div>

<div class="section s-blue">
  <div class="section-h"><h3 style="margin:0">Ad spend — Daily (USD)</h3><span class="muted">Replace by platform+country+product</span></div>
  <form method="post" action="{{ url_for('upsert_current_spend') }}">
    <div class="form-row">
      <select name="platform"><option>Facebook</option><option>TikTok</option><option>Google</option></select>
      <select name="country_code">
        {% for code in ctr_codes %}<option>{{ code }}</option>{% endfor %}
      </select>
      <select name="product_sku">{% for p in all_products %}<option value="{{ p.product_sku }}">{{ p.product_sku }} — {{ p.product_name }}</option>{% endfor %}</select>
      <input type="number" step="0.01" name="amount_usd" placeholder="Amount (USD)" required>
      <button class="btn">Save</button>
    </div>
  </form>
</div>

<div class="section s-orange">
  <div class="section-h"><h3 style="margin:0">Create stock movement — In transit</h3><span class="muted">From country → To country</span></div>
  <form method="post" action="{{ url_for('create_transfer_home') }}">
    <div class="form-row">
      <select name="from_code">
        <option>CN</option>
        {% for code in ctr_codes %}<option>{{ code }}</option>{% endfor %}
      </select>
      <select name="to_code">
        {% for code in ctr_codes %}<option>{{ code }}</option>{% endfor %}
      </select>
      <select name="product_sku">{% for p in all_products %}<option value="{{ p.product_sku }}">{{ p.product_sku }} — {{ p.product_name }}</option>{% endfor %}</select>
      <input type="number" name="qty" placeholder="Qty" required>
      <input type="number" step="0.01" name="shipping_cost_usd" placeholder="Shipping USD (est./final)">
      <input name="ref" placeholder="REF (e.g. SHP-KE-001)" required>
      <button class="btn">Create</button>
    </div>
  </form>
</div>

<div class="section s-orange">
  <div class="section-h"><h3 style="margin:0">Shipments in transit — China → Kenya</h3><span class="muted">Mark arrived or edit</span></div>
  <table class="table">
    <tr><th>Ref</th><th>Items</th><th>Sent</th><th>Ship USD</th><th></th><th></th></tr>
    {% for s in cn_ke %}
      <tr>
        <td>{{ s.ref }}</td><td>{{ s.items_str }}</td>
        <td>{{ s.created_date or '-' }}</td>
        <td>
          <form method="post" action="{{ url_for('update_shipment_cost') }}">
            <input type="hidden" name="shipment_id" value="{{ s.id }}">
            <input class="t-right" type="number" step="0.01" name="shipping_cost_usd" value="{{ s.shipping_cost_usd or 0 }}" style="width:120px">
            <button class="btn small">Save</button>
          </form>
        </td>
        <td>
          <form method="post" action="{{ url_for('mark_arrived') }}">
            <input type="hidden" name="shipment_id" value="{{ s.id }}">
            <button class="btn small">Arrived</button>
          </form>
        </td>
        <td>
          <form method="post" action="{{ url_for('delete_shipment') }}" onsubmit="return confirm('Delete this shipment?');">
            <input type="hidden" name="shipment_id" value="{{ s.id }}">
            <button class="btn danger small">Delete</button>
          </form>
        </td>
      </tr>
    {% endfor %}
    {% if not cn_ke %}<tr><td colspan="6" class="muted">None</td></tr>{% endif %}
  </table>
</div>

<div class="section s-orange">
  <div class="section-h"><h3 style="margin:0">Shipments in transit — Inter-country</h3><span class="muted">Edit qty / delete item or shipment / mark arrived</span></div>
  <table class="table">
    <tr><th>Ref</th><th>From</th><th>To</th><th>Item</th><th class="num">Qty</th><th>Sent</th><th>Ship USD</th><th></th><th></th><th></th></tr>
    {% for row in inter_items %}
      <tr>
        <td>{{ row.ref }}</td>
        <td>{{ row.from_country }}</td>
        <td>{{ row.to_country }}</td>
        <td>{{ row.product_sku }}</td>
        <td class="num">
          <form method="post" action="{{ url_for('edit_shipment_item_qty') }}">
            <input type="hidden" name="shipment_item_id" value="{{ row.item_id }}">
            <input type="number" name="qty" value="{{ row.qty }}" style="width:90px">
            <button class="btn small">Update</button>
          </form>
        </td>
        <td>{{ row.created_date or '-' }}</td>
        <td>
          <form method="post" action="{{ url_for('update_shipment_cost') }}">
            <input type="hidden" name="shipment_id" value="{{ row.shipment_id }}">
            <input class="t-right" type="number" step="0.01" name="shipping_cost_usd" value="{{ row.shipping_cost_usd or 0 }}" style="width:110px">
            <button class="btn small">Save</button>
          </form>
        </td>
        <td>
          <form method="post" action="{{ url_for('delete_shipment_item') }}" onsubmit="return confirm('Delete this item?');">
            <input type="hidden" name="shipment_item_id" value="{{ row.item_id }}">
            <button class="btn danger small">Delete item</button>
          </form>
        </td>
        <td>
          <form method="post" action="{{ url_for('delete_shipment') }}" onsubmit="return confirm('Delete shipment?');">
            <input type="hidden" name="shipment_id" value="{{ row.shipment_id }}">
            <button class="btn danger small">Delete shipment</button>
          </form>
        </td>
        <td>
          <form method="post" action="{{ url_for('mark_arrived') }}">
            <input type="hidden" name="shipment_id" value="{{ row.shipment_id }}">
            <button class="btn small">Arrived</button>
          </form>
        </td>
      </tr>
    {% endfor %}
    {% if not inter_items %}<tr><td colspan="10" class="muted">None</td></tr>{% endif %}
  </table>
</div>

<div class="section s-purple">
  <div class="section-h"><h3 style="margin:0">Daily delivered — compact view</h3>
    <span class="muted">One row per date; columns per country</span></div>
  <div class="subgrid">
    <form method="post" action="{{ url_for('add_daily_delivered') }}">
      <div class="form-row">
        <input type="date" name="date" required>
        <select name="country_code">
          {% for code in ctr_codes %}<option>{{ code }}</option>{% endfor %}
        </select>
        <input type="number" name="delivered" placeholder="Delivered count" required>
        <button class="btn">Add / Update</button>
      </div>
    </form>
    <form method="get" action="{{ url_for('index') }}">
      <div class="form-row">
        <input type="date" name="dfrom" value="{{ dfrom or '' }}">
        <input type="date" name="dto" value="{{ dto or '' }}">
        <button class="btn ghost">Filter</button>
      </div>
    </form>
  </div>
  <table class="table">
    <tr><th>Date</th>
      {% for code in ctr_codes %}<th class="num">{{ code }}</th>{% endfor %}
      <th class="num">Total</th></tr>
    {% for row in daily_pivot %}
      <tr>
        <td>{{ row.date }}</td>
        <td class="num">{{ row.KE }}</td>
        <td class="num">{{ row.UG }}</td>
        <td class="num">{{ row.TZ }}</td>
        <td class="num">{{ row.ZM }}</td>
        <td class="num">{{ row.ZW }}</td>
        <td class="num total">{{ row.total }}</td>
      </tr>
    {% endfor %}
    {% if not daily_pivot %}<tr><td colspan="7" class="muted">No entries</td></tr>{% endif %}
  </table>
</div>

<div class="section s-teal">
  <div class="section-h">
    <h3 style="margin:0">Top delivered products — report</h3>
    <span class="muted">Period + Country filter; export CSV</span>
  </div>
  <form method="get" action="{{ url_for('index') }}">
    <div class="form-row">
      <select name="tp">
        <option value="10d" {% if tp=='10d' %}selected{% endif %}>Last 10 days</option>
        <option value="21d" {% if tp=='21d' %}selected{% endif %}>Last 21 days</option>
        <option value="35d" {% if tp=='35d' %}selected{% endif %}>Last 35 days</option>
        <option value="60d" {% if tp=='60d' %}selected{% endif %}>Last 60 days</option>
        <option value="3m" {% if tp=='3m' %}selected{% endif %}>Last 3 months</option>
        <option value="6m" {% if tp=='6m' %}selected{% endif %}>Last 6 months</option>
        <option value="1y" {% if tp=='1y' %}selected{% endif %}>Last 1 year</option>
      </select>
      <select name="tc">
        <option value="" {% if not tc %}selected{% endif %}>All Countries</option>
        {% for code in ctr_codes %}<option value="{{ code }}" {% if tc==code %}selected{% endif %}>{{ code }}</option>{% endfor %}
      </select>
      <button class="btn">Show</button>
      <a class="btn ghost" href="{{ url_for('export_top_delivered', tp=tp, tc=tc) }}">Export CSV</a>
    </div>
  </form>
  <table class="table">
    <tr><th>Country</th><th>Product</th><th class="num">Orders</th><th class="num">Pieces</th><th class="num">Revenue USD</th><th class="num">Profit USD</th><th class="num">Profit/pc</th></tr>
    {% for r in top_report %}
      <tr>
        <td>{{ r.country_code }}</td>
        <td>{{ r.product_sku }}</td>
        <td class="num">{{ r.orders }}</td>
        <td class="num">{{ r.pieces }}</td>
        <td class="num">${{ '%.2f'|format(r.revenue_usd or 0) }}</td>
        <td class="num"><b>${{ '%.2f'|format(r.profit_total_usd or 0) }}</b></td>
        <td class="num">${{ '%.2f'|format(r.profit_per_piece_usd or 0) }}</td>
      </tr>
    {% endfor %}
    {% if not top_report %}<tr><td colspan="7" class="muted">No data for selected period</td></tr>{% endif %}
  </table>
</div>

<div class="section s-blue">
  <div class="section-h"><h3 style="margin:0">Add Country</h3><span class="muted">Instantly available everywhere</span></div>
  <form method="post" action="{{ url_for('add_country') }}">
    <div class="form-row">
      <input name="country" placeholder="Country name" required>
      <input name="code" placeholder="Code (e.g. GH)" required>
      <input name="currency" placeholder="Currency (e.g. USD)" required>
      <input type="number" step="0.0001" name="fx_to_usd" placeholder="FX to USD (e.g. 1.0)" required>
      <button class="btn">Add</button>
    </div>
  </form>
</div>
{% endblock %}
