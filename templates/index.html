{% extends "base.html" %}
{% block content %}
<div class="grid">
  <div class="card kpi"><div class="muted">Active Products</div><div class="v">{{ counts.products }}</div></div>
  <div class="card kpi"><div class="muted">Warehouses</div><div class="v">{{ counts.warehouses }}</div></div>
  <div class="card kpi"><div class="muted">In-Transit</div><div class="v">{{ counts.in_transit }}</div></div>
</div>

<div class="section s-green">
  <div class="section-h"><h3 style="margin:0">Country band — totals</h3><span class="muted">Stock / In-transit / Ad spend</span></div>
  <div class="grid">
    {% for name,vals in band.items() %}
      <div class="card">
        <div class="muted">{{ vals.code }} — {{ name }}</div>
        <div class="subgrid">
          <div><div class="small muted">Stock</div><div class="v">{{ vals.stock }}</div></div>
          <div><div class="small muted">In-Transit</div><div class="v">{{ vals.in_transit }}</div></div>
          <div><div class="small muted">Ad Spend</div><div class="v">${{ '%.2f'|format(vals.ad_spend or 0) }}</div></div>
        </div>
      </div>
    {% endfor %}
  </div>
</div>

<div class="section s-blue">
  <div class="section-h"><h3 style="margin:0">Ad spend — Daily (USD)</h3><span class="muted">Replace per platform, country & product</span></div>
  <form method="post" action="{{ url_for('upsert_current_spend') }}">
    <div class="form-row">
      <select name="platform"><option>Facebook</option><option>TikTok</option><option>Google</option></select>
      <select name="country_code">{% for c in countries %}<option>{{ c.code }}</option>{% endfor %}</select>
      <select name="product_sku">{% for p in all_products %}<option value="{{ p.product_sku }}">{{ p.product_sku }} — {{ p.product_name }}</option>{% endfor %}</select>
      <input type="number" step="0.01" name="amount_usd" placeholder="USD" required>
      <button class="btn">Save</button>
    </div>
  </form>
  <div class="table-wrap">
    <table class="table">
      <tr><th>Country</th><th class="num">Facebook</th><th class="num">TikTok</th><th class="num">Google</th><th class="num">Total</th></tr>
      {% for c in countries %}
        {% set r = spend_c_summary.get(c.code, {}) %}
        <tr>
          <td>{{ c.code }}</td>
          <td class="num">${{ '%.2f'|format(r.get('Facebook',0)) }}</td>
          <td class="num">${{ '%.2f'|format(r.get('TikTok',0)) }}</td>
          <td class="num">${{ '%.2f'|format(r.get('Google',0)) }}</td>
          <td class="num total">${{ '%.2f'|format(r.get('total',0)) }}</td>
        </tr>
      {% endfor %}
    </table>
  </div>
</div>

<div class="section s-orange">
  <div class="section-h"><h3 style="margin:0">Create stock movement — In transit</h3><span class="muted">From → To</span></div>
  <form method="post" action="{{ url_for('create_transfer_home') }}">
    <div class="form-row">
      <select name="from_code"><option>CN</option>{% for c in countries %}<option>{{ c.code }}</option>{% endfor %}</select>
      <select name="to_code">{% for c in countries %}<option>{{ c.code }}</option>{% endfor %}</select>
      <select name="product_sku">{% for p in all_products %}<option value="{{ p.product_sku }}">{{ p.product_sku }} — {{ p.product_name }}</option>{% endfor %}</select>
      <input type="number" name="qty" placeholder="Qty" required>
      <input type="number" step="0.01" name="shipping_cost_usd" placeholder="Shipping USD (est./final)">
      <input name="ref" placeholder="REF" required>
      <button class="btn">Create</button>
    </div>
  </form>
</div>

<div class="section s-orange">
  <div class="section-h"><h3 style="margin:0">Shipments in transit — China → Kenya</h3></div>
  <div class="table-wrap">
    <table class="table">
      <tr><th>Ref</th><th>Items</th><th>Sent</th><th class="num">Ship USD</th><th></th><th></th></tr>
      {% for sh,items in cn_ke %}
      <tr>
        <td>{{ sh.ref }}</td>
        <td>{{ ", ".join([i.product_sku ~ ":" ~ i.qty for i in items]) }}</td>
        <td>{{ sh.created_date or '-' }}</td>
        <td>
          <form method="post" action="{{ url_for('update_shipment_cost') }}">
            <input type="hidden" name="shipment_id" value="{{ sh.id }}">
            <input class="t-right" type="number" step="0.01" name="shipping_cost_usd" value="{{ sh.shipping_cost_usd or 0 }}" style="width:120px">
            <button class="btn small">Save</button>
          </form>
        </td>
        <td><form method="post" action="{{ url_for('mark_arrived') }}"><input type="hidden" name="shipment_id" value="{{ sh.id }}"><button class="btn small">Arrived</button></form></td>
        <td><form method="post" action="{{ url_for('delete_shipment') }}" onsubmit="return confirm('Delete shipment?');"><input type="hidden" name="shipment_id" value="{{ sh.id }}"><button class="btn danger small">Delete</button></form></td>
      </tr>
      {% endfor %}
      {% if not cn_ke %}<tr><td colspan="6" class="muted">None</td></tr>{% endif %}
    </table>
  </div>
</div>

<div class="section s-orange">
  <div class="section-h"><h3 style="margin:0">Shipments in transit — Between countries</h3></div>
  <div class="table-wrap">
    <table class="table">
      <tr><th>Ref</th><th>From</th><th>To</th><th>SKU</th><th class="num">Qty</th><th>Sent</th><th class="num">Ship USD</th><th></th><th></th><th></th></tr>
      {% for sh,it in inter_items %}
      <tr>
        <td>{{ sh.ref }}</td><td>{{ sh.from_country }}</td><td>{{ sh.to_country }}</td><td>{{ it.product_sku }}</td>
        <td class="num">
          <form method="post" action="{{ url_for('edit_shipment_item_qty') }}"><input type="hidden" name="shipment_item_id" value="{{ it.id }}"><input type="number" name="qty" value="{{ it.qty }}" style="width:90px"><button class="btn small">Update</button></form>
        </td>
        <td>{{ sh.created_date or '-' }}</td>
        <td>
          <form method="post" action="{{ url_for('update_shipment_cost') }}"><input type="hidden" name="shipment_id" value="{{ sh.id }}"><input class="t-right" type="number" step="0.01" name="shipping_cost_usd" value="{{ sh.shipping_cost_usd or 0 }}" style="width:110px"><button class="btn small">Save</button></form>
        </td>
        <td><form method="post" action="{{ url_for('delete_shipment_item') }}" onsubmit="return confirm('Delete item?');"><input type="hidden" name="shipment_item_id" value="{{ it.id }}"><button class="btn danger small">Delete item</button></form></td>
        <td><form method="post" action="{{ url_for('delete_shipment') }}" onsubmit="return confirm('Delete shipment?');"><input type="hidden" name="shipment_id" value="{{ sh.id }}"><button class="btn danger small">Delete shipment</button></form></td>
        <td><form method="post" action="{{ url_for('mark_arrived') }}"><input type="hidden" name="shipment_id" value="{{ sh.id }}"><button class="btn small">Arrived</button></form></td>
      </tr>
      {% endfor %}
      {% if not inter_items %}<tr><td colspan="10" class="muted">None</td></tr>{% endif %}
    </table>
  </div>
</div>

<div class="section s-teal">
  <div class="section-h"><h3 style="margin:0">Weekly Delivered (Mon→Sun)</h3><span class="muted">{{ week_start }} → {{ week_end }}</span></div>
  <div class="table-wrap">
    <table class="table">
      <tr><th>Country</th><th class="num">Delivered</th></tr>
      {% for c in countries %}<tr><td>{{ c.code }}</td><td class="num total">{{ weekly_totals.get(c.code,0) }}</td></tr>{% endfor %}
      <tr><td class="total">TOTAL</td><td class="num total">{{ weekly_grand }}</td></tr>
    </table>
  </div>
</div>

<div class="section s-purple">
  <div class="section-h"><h3 style="margin:0">Daily delivered — recent 8 days</h3></div>
  <form method="post" action="{{ url_for('add_daily_delivered') }}">
    <div class="form-row">
      <input type="date" name="date" required>
      <select name="country_code">{% for c in countries %}<option>{{ c.code }}</option>{% endfor %}</select>
      <input type="number" name="delivered" placeholder="Delivered" required>
      <button class="btn">Save</button>
    </div>
  </form>
  <div class="table-wrap">
    <table class="table">
      <tr><th>Date</th>{% for code in ctr_codes %}<th class="num">{{ code }}</th>{% endfor %}<th class="num">Total</th></tr>
      {% for row in daily_pivot %}
      <tr>
        <td>{{ row.date }}</td>
        {% for code in ctr_codes %}<td class="num">{{ row[code] }}</td>{% endfor %}
        <td class="num total">{{ row.total }}</td>
      </tr>
      {% endfor %}
      {% if not daily_pivot %}<tr><td colspan="99" class="muted">No entries</td></tr>{% endif %}
    </table>
  </div>
</div>
{% endblock %}
