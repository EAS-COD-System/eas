{% extends "base.html" %}
{% block content %}
<h3 class="mb-3">Dashboard</h3>

<!-- Top stats -->
<div class="row g-3">
  <div class="col-md-4">
    <div class="card p-3 text-center">
      <div class="small text-muted">Active Products</div>
      <div class="fs-4 fw-semibold">{{ counts.products }}</div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card p-3 text-center">
      <div class="small text-muted">Warehouses</div>
      <div class="fs-4 fw-semibold">{{ counts.warehouses }}</div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card p-3 text-center">
      <div class="small text-muted">In-Transit Shipments</div>
      <div class="fs-4 fw-semibold">{{ counts.in_transit }}</div>
    </div>
  </div>
</div>

<!-- Country band — Totals -->
<h5 class="mt-4">Country band — Totals</h5>
<div class="table-responsive">
  <table class="table table-bordered table-striped align-middle">
    <thead>
      <tr>
        <th>Country</th>
        <th>Stock</th>
        <th>In transit</th>
        <th>Ad spend (USD)</th>
      </tr>
    </thead>
    <tbody>
      {% for country, v in band.items() %}
      <tr>
        <td>{{ country }}</td>
        <td>{{ v.stock }}</td>
        <td>{{ v.in_transit }}</td>
        <td>${{ '%.2f'|format(v.ad_spend or 0.0) }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Shipments in transit -->
<h5 class="mt-4">Shipments in transit — China → Kenya</h5>
<div class="table-responsive">
  <table class="table table-bordered table-striped">
    <thead>
      <tr>
        <th>Ref</th><th>Created</th><th>Items</th><th>Ship cost (USD)</th><th>Status</th><th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% if cn_ke and cn_ke|length %}
        {% for sh in cn_ke %}
        <tr>
          <td>{{ sh.ref }}</td>
          <td>{{ sh.created_date }}</td>
          <td>
            {% set qty = 0 %}
            {% for it in sh.items %}{% set qty = qty + (it.qty or 0) %}{% endfor %}
            {{ qty }}
          </td>
          <td>${{ '%.2f'|format(sh.shipping_cost_usd or 0.0) }}</td>
          <td>{{ sh.status }}</td>
          <td>
            {% if sh.status == 'in_transit' %}
            <form method="post" action="/shipment/mark-arrived" class="d-inline">
              <input type="hidden" name="shipment_id" value="{{ sh.id }}">
              <button class="btn btn-success btn-sm">Mark arrived</button>
            </form>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="6" class="text-muted">No shipments in transit.</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

<h5 class="mt-4">Shipments in transit — Between countries</h5>
<div class="table-responsive">
  <table class="table table-bordered table-striped">
    <thead>
      <tr>
        <th>Ref</th><th>From</th><th>To</th><th>Product</th><th>Qty</th><th>Created</th><th>Ship cost (USD)</th><th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% if inter_items and inter_items|length %}
        {% for r in inter_items %}
        <tr>
          <td>{{ r.ref }}</td>
          <td>{{ r.from_country }}</td>
          <td>{{ r.to_country }}</td>
          <td>{{ r.product_sku }}</td>
          <td>{{ r.qty }}</td>
          <td>{{ r.created_date }}</td>
          <td>${{ '%.2f'|format(r.shipping_cost_usd or 0.0) }}</td>
          <td>
            <form method="post" action="/shipment/mark-arrived">
              <input type="hidden" name="shipment_id" value="{{ r.shipment_id }}">
              <button class="btn btn-success btn-sm">Mark arrived</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="8" class="text-muted">No inter-country shipments in transit.</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

<!-- Weekly delivered summary -->
<h5 class="mt-4">Delivered — this week (Mon–Sun)</h5>
<p class="text-muted small">Week total: <b>{{ week_total }}</b></p>
<div class="table-responsive">
  <table class="table table-bordered">
    <thead><tr><th>Country</th><th>Delivered</th></tr></thead>
    <tbody>
      {% for code, val in week_map.items() %}
      <tr><td>{{ code }}</td><td>{{ val }}</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
