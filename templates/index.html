{% extends "base.html" %}
{% block content %}
<h4>Dashboard</h4>

<div class="row g-3 mb-3">
  <div class="col-md-4"><div class="card p-3 text-center"><div class="small">Products</div><div class="fs-4">{{ counts.products }}</div></div></div>
  <div class="col-md-4"><div class="card p-3 text-center"><div class="small">Warehouses (Countries)</div><div class="fs-4">{{ counts.warehouses }}</div></div></div>
  <div class="col-md-4"><div class="card p-3 text-center"><div class="small">Shipments In Transit</div><div class="fs-4">{{ counts.in_transit }}</div></div></div>
</div>

<h6>Warehouse / Stock Summary</h6>
<div class="table-responsive">
<table class="table table-bordered table-striped">
  <thead><tr><th>Country</th><th>Stock</th><th>In Transit</th><th>Daily Ad Spend (USD)</th></tr></thead>
  <tbody>
    {% for cc, v in band.items() %}
      <tr><td>{{ v.name }}</td><td>{{ v.stock }}</td><td>{{ v.in_transit }}</td><td>${{ '%.2f'|format(v.ad_spend or 0.0) }}</td></tr>
    {% endfor %}
  </tbody>
  <tfoot><tr class="fw-bold"><td>Total</td><td>{{ total.stock }}</td><td>{{ total.in_transit }}</td><td>${{ '%.2f'|format(total.ad_spend) }}</td></tr></tfoot>
</table>
</div>

<div class="row g-3">
  <div class="col-md-6">
    <div class="card p-3">
      <h6>Add / Update Daily Delivered</h6>
      <form method="post" action="/delivered/add" class="row g-2">
        <div class="col-md-3">
          <select class="form-select" name="country" required>
            {% for c in countries if c.code!='CN' %}<option value="{{ c.code }}">{{ c.name }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-md-4"><input type="date" class="form-control" name="day"></div>
        <div class="col-md-3"><input type="number" class="form-control" name="delivered" placeholder="Delivered" required></div>
        <div class="col-md-2"><button class="btn btn-success w-100">Save</button></div>
      </form>
      <hr/>
      <div>Week total (Mon–Sun): <b>{{ week_total }}</b></div>
      <div class="table-responsive mt-2">
        <table class="table table-sm">
          <thead><tr><th>Country</th><th>Delivered</th></tr></thead>
          <tbody>
            {% for code,val in week_map.items() %}<tr><td>{{ code }}</td><td>{{ val }}</td></tr>{% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card p-3">
      <h6>Set Daily Ad Spend (overwrites)</h6>
      <form method="post" action="/spend/set" class="row g-2">
        <div class="col-md-3">
          <select class="form-select" name="sku" required>
            {% for p in products %}<option value="{{ p.sku }}">{{ p.sku }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <select class="form-select" name="country" required>
            {% for c in countries if c.code!='CN' %}<option value="{{ c.code }}">{{ c.name }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <select class="form-select" name="platform" required>
            <option value="facebook">Facebook</option>
            <option value="tiktok">TikTok</option>
            <option value="google">Google</option>
          </select>
        </div>
        <div class="col-md-2"><input type="number" step="0.01" class="form-control" name="amount" placeholder="USD" required></div>
        <div class="col-md-1"><button class="btn btn-success w-100">Save</button></div>
      </form>
    </div>
  </div>
</div>

<div class="card p-3 mt-3">
  <h6>Create Stock Movement</h6>
  <form method="post" action="/shipment/create" class="row g-2">
    <div class="col-md-2"><input class="form-control" name="ref" placeholder="Ref (optional)"></div>
    <div class="col-md-2">
      <select class="form-select" name="from_country" required>
        {% for c in countries %}<option value="{{ c.code }}">{{ c.name }}</option>{% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <select class="form-select" name="to_country" required>
        {% for c in countries if c.code!='CN' %}<option value="{{ c.code }}">{{ c.name }}</option>{% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <select class="form-select" name="sku" required>
        {% for p in products %}<option value="{{ p.sku }}">{{ p.sku }}</option>{% endfor %}
      </select>
    </div>
    <div class="col-md-2"><input class="form-control" name="qty" type="number" placeholder="Qty" required></div>
    <div class="col-md-2"><input class="form-control" name="shipping_cost" type="number" step="0.01" placeholder="Ship Cost USD"></div>
    <div class="col-md-12"><button class="btn btn-success">Create</button></div>
  </form>
</div>

<h6 class="mt-3">Shipments in Transit — China → Kenya</h6>
<div class="table-responsive">
<table class="table table-bordered">
  <thead><tr><th>Ref</th><th>Created</th><th>Qty (all items)</th><th>Cost</th><th>Status</th><th>Actions</th></tr></thead>
  <tbody>
    {% for sh in cn_ke %}
    <tr>
      <td>{{ sh.ref }}</td>
      <td>{{ sh.created_at.date() }}</td>
      <td>{{ sh.items|map(attribute='qty')|sum }}</td>
      <td>${{ '%.2f'|format(sh.shipping_cost_usd or 0.0) }}</td>
      <td>{{ sh.status }}</td>
      <td class="d-flex gap-1">
        <form method="post" action="/shipment/mark-arrived">
          <input type="hidden" name="shipment_id" value="{{ sh.id }}">
          <button class="btn btn-success btn-sm">Arrived</button>
        </form>
        <form method="post" action="/shipment/edit" class="d-flex gap-1">
          <input type="hidden" name="shipment_id" value="{{ sh.id }}">
          <input class="form-control form-control-sm" name="qty" type="number" placeholder="Qty">
          <input class="form-control form-control-sm" name="shipping_cost" type="number" step="0.01" placeholder="Cost">
          <button class="btn btn-warning btn-sm">Edit</button>
        </form>
        <form method="post" action="/shipment/delete">
          <input type="hidden" name="shipment_id" value="{{ sh.id }}">
          <button class="btn btn-danger btn-sm">Delete</button>
        </form>
      </td>
    </tr>
    {% else %}<tr><td colspan="6" class="text-muted">None</td></tr>{% endfor %}
  </tbody>
</table>
</div>

<h6 class="mt-3">Shipments in Transit — Between Countries</h6>
<div class="table-responsive">
<table class="table table-bordered">
  <thead><tr><th>Ref</th><th>From</th><th>To</th><th>Qty</th><th>Cost</th><th>Status</th><th>Actions</th></tr></thead>
  <tbody>
    {% for sh in inter %}
    <tr>
      <td>{{ sh.ref }}</td>
      <td>{{ sh.from_country }}</td>
      <td>{{ sh.to_country }}</td>
      <td>{{ sh.items|map(attribute='qty')|sum }}</td>
      <td>${{ '%.2f'|format(sh.shipping_cost_usd or 0.0) }}</td>
      <td>{{ sh.status }}</td>
      <td class="d-flex gap-1">
        <form method="post" action="/shipment/mark-arrived">
          <input type="hidden" name="shipment_id" value="{{ sh.id }}">
          <button class="btn btn-success btn-sm">Arrived</button>
        </form>
        <form method="post" action="/shipment/edit" class="d-flex gap-1">
          <input type="hidden" name="shipment_id" value="{{ sh.id }}">
          <input class="form-control form-control-sm" name="qty" type="number" placeholder="Qty">
          <input class="form-control form-control-sm" name="shipping_cost" type="number" step="0.01" placeholder="Cost">
          <button class="btn btn-warning btn-sm">Edit</button>
        </form>
        <form method="post" action="/shipment/delete">
          <input type="hidden" name="shipment_id" value="{{ sh.id }}">
          <button class="btn btn-danger btn-sm">Delete</button>
        </form>
      </td>
    </tr>
    {% else %}<tr><td colspan="7" class="text-muted">None</td></tr>{% endfor %}
  </tbody>
</table>
</div>

<div class="card p-3 mt-3">
  <h6>To-Do</h6>
  <form method="post" action="/add_task" class="row g-2 mb-2">
    <div class="col-md-6"><input class="form-control" name="task" placeholder="Task"></div>
    <div class="col-md-3">
      <select class="form-select" name="status">
        <option value="pending">Pending</option>
        <option value="in_progress">In Progress</option>
        <option value="done">Done</option>
      </select>
    </div>
    <div class="col-md-2">
      <select class="form-select" name="week_day">
        <option value="">(no day)</option>
        <option>Monday</option><option>Tuesday</option><option>Wednesday</option>
        <option>Thursday</option><option>Friday</option><option>Saturday</option><option>Sunday</option>
      </select>
    </div>
    <div class="col-md-1"><button class="btn btn-success w-100">Add</button></div>
  </form>
  <div class="table-responsive">
    <table class="table table-sm">
      <thead><tr><th>Task</th><th>Status</th><th>Day</th><th></th></tr></thead>
      <tbody>
        {% for t in Todo.query.order_by(Todo.id.desc()).all() %}
        <tr>
          <td>{{ t.text }}</td><td>{{ t.status }}</td><td>{{ t.week_day or '-' }}</td>
          <td>
            <form method="post" action="/delete_task">
              <input type="hidden" name="task_id" value="{{ t.id }}">
              <button class="btn btn-danger btn-sm">Delete</button>
            </form>
          </td>
        </tr>
        {% else %}<tr><td colspan="4" class="text-muted">No tasks</td></tr>{% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}
