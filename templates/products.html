{% extends 'base.html' %}
{% block title %}Products{% endblock %}
{% block content %}

<div class="card">
  <h2 style="margin:0">Products</h2>
  <form method="post" action="/products/add" style="margin-top:12px">
    <div class="row">
      <div class="col">
        <label>Name</label>
        <input class="input" name="name" required>
      </div>
      <div class="col">
        <label>SKU</label>
        <input class="input" name="sku">
      </div>
      <div class="col">
        <label>Cost in China (USD)</label>
        <input class="input" type="number" step="0.01" name="price_cn" value="0">
      </div>
      <div class="col">
        <label>Ship CN→KE per pc (USD)</label>
        <input class="input" type="number" step="0.01" name="ship_cn_ke" value="0">
      </div>
      <div class="col" style="align-self:flex-end">
        <button class="btn">Add product</button>
      </div>
    </div>
  </form>
</div>

{% for p in products %}
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h3 style="margin:0">{{ p.name }} <span class="muted">#{{ p.id }}</span></h3>
    <form method="post" action="/products/delete" onsubmit="return confirm('Delete product {{ p.name }}?')">
      <input type="hidden" name="product_id" value="{{ p.id }}">
      <button class="btn outline small">Delete</button>
    </form>
  </div>

  <div class="row" style="margin-top:10px">
    <div class="col">
      <div class="pill">Cost in China: {{ '%.2f'|format(p.cost_cn_usd or 0) }} USD</div>
    </div>
    <div class="col">
      <div class="pill">Ship CN→KE: {{ '%.2f'|format(p.ship_cn_ke_usd or 0) }} USD/pc</div>
    </div>
  </div>

  <!-- 1) Available stock + total spend + Profit+Ads per country (editable) -->
  <h4 style="margin-top:16px">Country Summary</h4>
  <table>
    <thead><tr><th>Country</th><th style="text-align:right">Stock</th><th style="text-align:right">Ad Spend (USD)</th><th style="text-align:right">Profit+Ads (USD)</th><th>Update</th></tr></thead>
    <tbody>
      {% for c in countries if c.code != 'CN' %}
      {% set s = stock_map.get((p.id, c.code), 0) %}
      {% set spend = spend_map.get((p.id, c.code), 0.0) %}
      {% set pa = profit_ads_map.get((p.id, c.code), 0.0) %}
      <tr>
        <td>{{ c.name }}</td>
        <td style="text-align:right">{{ s }}</td>
        <td style="text-align:right">{{ '%.2f'|format(spend) }}</td>
        <td style="text-align:right">{{ '%.2f'|format(pa) }}</td>
        <td>
          <form method="post" action="/products/{{ p.id }}/profit_ads/update" class="row">
            <input type="hidden" name="country" value="{{ c.code }}">
            <div class="col"><input class="input" type="number" step="0.01" name="profit_ads" value="{{ '%.2f'|format(pa) }}"></div>
            <div class="col" style="flex:0 0 auto"><button class="btn small">Save</button></div>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- 2) Remittance profit snapshot (summary) -->
  <h4 style="margin-top:16px">Profit (from Remittances)</h4>
  <table>
    <thead><tr><th>Country</th><th style="text-align:right">Orders</th><th style="text-align:right">Pieces</th><th style="text-align:right">Revenue (USD)</th><th style="text-align:right">Ads (USD)</th><th style="text-align:right">Inter-ship (USD)</th></tr></thead>
    <tbody>
      {% for c in countries if c.code != 'CN' %}
      {% set rp = remittance_map.get((p.id, c.code), {'orders':0,'pieces':0,'revenue':0.0,'ads':0.0,'inter':0.0}) %}
      <tr>
        <td>{{ c.name }}</td>
        <td style="text-align:right">{{ rp.orders }}</td>
        <td style="text-align:right">{{ rp.pieces }}</td>
        <td style="text-align:right">{{ '%.2f'|format(rp.revenue) }}</td>
        <td style="text-align:right">{{ '%.2f'|format(rp.ads) }}</td>
        <td style="text-align:right">{{ '%.2f'|format(rp.inter) }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- 3) Transit CN→KE (per product) -->
  <h4 style="margin-top:16px">Transit CN→KE</h4>
  <table>
    <thead><tr><th>ID</th><th>Qty</th><th>Cost (USD)</th><th>Action</th></tr></thead>
    <tbody>
      {% for s in cnke_by_product.get(p.id, []) %}
      <tr>
        <td>#{{ s.id }}</td>
        <td>{{ s.qty }}</td>
        <td>{{ '%.2f'|format(s.cost) }}</td>
        <td>
          <form method="post" action="/shipments/arrive"><input type="hidden" name="shipment_id" value="{{ s.id }}"><button class="btn small">Mark arrived</button></form>
          <form method="post" action="/shipments/delete" style="display:inline-block;margin-left:6px"><input type="hidden" name="shipment_id" value="{{ s.id }}"><button class="btn small outline">Delete</button></form>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="4" class="muted">No CN→KE in transit for this product.</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- 4) Transit between countries (per product) -->
  <h4 style="margin-top:16px">Transit Between Countries</h4>
  <table>
    <thead><tr><th>ID</th><th>From</th><th>To</th><th>Qty</th><th>Cost (USD)</th><th>Action</th></tr></thead>
    <tbody>
      {% for s in inter_by_product.get(p.id, []) %}
      <tr>
        <td>#{{ s.id }}</td>
        <td>{{ s.from }}</td>
        <td>{{ s.to }}</td>
        <td>{{ s.qty }}</td>
        <td>{{ '%.2f'|format(s.cost) }}</td>
        <td>
          <form method="post" action="/shipments/arrive"><input type="hidden" name="shipment_id" value="{{ s.id }}"><button class="btn small">Mark arrived</button></form>
          <form method="post" action="/shipments/delete" style="display:inline-block;margin-left:6px"><input type="hidden" name="shipment_id" value="{{ s.id }}"><button class="btn small outline">Delete</button></form>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="6" class="muted">No inter-country in transit for this product.</td></tr>
      {% endfor %}
    </tbody>
  </table>

</div>
{% else %}
<div class="card"><p class="muted">No products yet. Add your first product above.</p></div>
{% endfor %}

{% endblock %}
