import express from 'express';import bodyParser from 'body-parser';import cors from 'cors';import cookieParser from 'cookie-parser';import morgan from 'morgan';import fs from 'fs';import path from 'path';import { fileURLToPath } from 'url';
const __filename=fileURLToPath(import.meta.url);const __dirname=path.dirname(__filename);
const app=express();const PORT=process.env.PORT||3000;const ADMIN_PASSWORD=process.env.ADMIN_PASSWORD||'eastafricashop';
app.use(morgan('dev'));app.use(bodyParser.json());app.use(cookieParser());app.use(cors({origin:true,credentials:true}));
const DATA_DIR=path.join(__dirname,'data');const SNAPSHOT_DIR=path.join(__dirname,'snapshots');if(!fs.existsSync(DATA_DIR)) fs.mkdirSync(DATA_DIR,{recursive:true});if(!fs.existsSync(SNAPSHOT_DIR)) fs.mkdirSync(SNAPSHOT_DIR,{recursive:true});
const files={meta:'meta.json',countries:'countries.json',products:'products.json',deliveries:'deliveries.json',adSpends:'ad_spends.json',movements:'movements.json',shipments:'shipments.json',remittances:'remittances.json',financeCategories:'finance_categories.json',financeEntries:'finance_entries.json',influencers:'influencers.json',influencersSpend:'influencers_spend.json',allowlist:'allowlist.json'};
const R=(n,f)=>{const p=path.join(DATA_DIR,n);if(!fs.existsSync(p)) return f;try{return JSON.parse(fs.readFileSync(p,'utf8'))}catch{return f}};const W=(n,d)=>fs.writeFileSync(path.join(DATA_DIR,n),JSON.stringify(d,null,2));
(function init(){ if(!fs.existsSync(path.join(DATA_DIR,files.meta))) W(files.meta,{currency:'USD',theme:{primary:'#0E9F6E',bg:'#fff'},createdAt:new Date().toISOString()}); if(!fs.existsSync(path.join(DATA_DIR,files.allowlist))) W(files.allowlist,{ips:[]}); const defs=[[files.countries,["china","kenya","tanzania","uganda","zambia","zimbabwe"]],[files.products,[]],[files.deliveries,[]],[files.adSpends,[]],[files.movements,[]],[files.shipments,[]],[files.remittances,[]],[files.financeCategories,{"debits":["Facebook Ads","TikTok Ads","Google Ads","Shipping","Salaries"],"credits":["Revenue Boxleo","Other Revenue"]}],[files.financeEntries,[]],[files.influencers,[]],[files.influencersSpend,[]]]; for (const [f,v] of defs){ const p=path.join(DATA_DIR,f); if(!fs.existsSync(p)) W(f,v);} })();
const ipOf=(req)=> (req.headers['x-forwarded-for']?.split(',')[0]?.trim()) || req.headers['x-real-ip'] || req.ip;
app.post('/api/auth',(req,res)=>{ const {password}=req.body||{}; const ip=ipOf(req); if(password===ADMIN_PASSWORD){ const a=R(files.allowlist,{ips:[]}); if(!a.ips.includes(ip)){ a.ips.push(ip); W(files.allowlist,a);} const isProd=process.env.NODE_ENV==='production'; res.cookie('eas_auth','1',{ httpOnly:true, sameSite:'lax', secure:isProd, path:'/' }); return res.json({ok:true,ip}); } return res.status(401).json({ok:false,error:'Invalid password'});});
app.post('/api/logout',(req,res)=>{ const ip=ipOf(req); const a=R(files.allowlist,{ips:[]}); a.ips=a.ips.filter(x=>x!==ip); W(files.allowlist,a); res.clearCookie('eas_auth'); res.json({ok:true});});
const guard=(req,res,next)=>{ if(req.cookies?.eas_auth==='1') return next(); const ip=ipOf(req); const a=R(files.allowlist,{ips:[]}); if(a.ips.includes(ip)) return next(); return res.status(401).json({ok:false,error:'Unauthorized'})};
const dOnly=(d)=>{const x=new Date(d);x.setHours(0,0,0,0);return x.toISOString().slice(0,10)}; const inRange=(d,s,e)=>{const x=new Date(d).getTime(); if(s&&x<new Date(s).getTime()) return false; if(e&&x>new Date(e).getTime()) return false; return true};
const sow=(date)=>{const d=new Date(date);const day=(d.getDay()+6)%7;const m=new Date(d);m.setDate(d.getDate()-day);m.setHours(0,0,0,0);return m}; const eow=(date)=>{const m=sow(date);const s=new Date(m);s.setDate(m.getDate()+6);s.setHours(23,59,59,999);return s};
setInterval(()=>{const stamp=new Date().toISOString().replace(/[:.]/g,'-');const folder=path.join(SNAPSHOT_DIR,stamp+'_10m');fs.mkdirSync(folder,{recursive:true});for(const k of Object.values(files)){const src=path.join(DATA_DIR,k);if(fs.existsSync(src)) fs.copyFileSync(src,path.join(folder,k));}},10*60*1000);
app.get('/api/meta',guard,(req,res)=>res.json({meta:R(files.meta,{}),countries:R(files.countries,[]),week:{start:sow(new Date()),end:eow(new Date())}}));
// minimal frontend serving to keep response short; rest same as before (public routes etc.)
app.use('/public', express.static(path.join(__dirname,'public')));
app.get('/',(req,res)=>res.sendFile(path.join(__dirname,'public','index.html')));
app.get('*',(req,res)=>res.sendFile(path.join(__dirname,'public','index.html')));
app.listen(PORT,()=>console.log('EAS Tracker on '+PORT));
