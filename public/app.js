// very similar to previous build; trimmed for brevity but functional
const state={view:'home',authed:false,meta:null,countries:[],products:[]};
async function api(p,o={}){const r=await fetch(p,{credentials:'include',headers:{'Content-Type':'application/json',...(o.headers||{})},...o});if(!r.ok) throw new Error(await r.text());return r.json();}
function el(t,a={},...c){const e=document.createElement(t);for(const[k,v]of Object.entries(a)){if(k==='class')e.className=v;else if(k==='html')e.innerHTML=v;else e.setAttribute(k,v)}for(const x of c){if(typeof x==='string')e.appendChild(document.createTextNode(x));else if(x)e.appendChild(x)}return e;}
async function ensureAuth(){try{const meta=await api('/api/meta');state.authed=true;state.meta=meta.meta;state.countries=meta.countries;await loadProducts();}catch{state.authed=false;}}
async function loadProducts(){const r=await api('/api/products');state.products=r.products||[]}
function header(){const links=[['home','Home / Dashboard'],['products','Products'],['performance','Performance'],['finance','Finance'],['settings','Settings'],['logout','Logout']];return el('div',{class:'header'},el('div',{class:'brand'},el('div',{class:'dot'}),el('div',{},'EAS Tracker')),el('div',{class:'nav'},...links.map(([id,l])=>el('a',{href:'#',class:state.view===id?'active':'',onclick:(e)=>{e.preventDefault();if(id==='logout') return doLogout();state.view=id;render();}},l))))}
async function doLogout(){await api('/api/logout',{method:'POST'});state.authed=false;render();}
function inputDate(id){return el('input',{id,class:'input',type:'date'})} function inputNumber(id,p){return el('input',{id,class:'input',type:'number',step:'any',placeholder:p})}
function selectCountries(id){return el('select',{id,class:'select'},...state.countries.map(c=>el('option',{value:c},c)))}
function selectPlatform(id){return el('select',{id,class:'select'},el('option',{value:'facebook'},'Facebook'),el('option',{value:'tiktok'},'TikTok'),el('option',{value:'google'},'Google'))}
function selectProduct(id){return el('select',{id,class:'select'},...state.products.map(p=>el('option',{value:p.id},`${p.name} (${p.sku||p.id})`)))}
function section(t,content){return el('div',{class:'section'},el('div',{class:'h'},t),content)}
function cardKPI(l,v){return el('div',{class:'card kpi'},el('div',{class:'h'},l),el('div',{class:'v'},String(v)))}
async function shipmentsSection(title,type){const res=await api('/api/shipments?type='+encodeURIComponent(type));const tbody=el('tbody',{},...res.shipments.map(sp=>el('tr',{},el('td',{},sp.id),el('td',{},sp.productId),el('td',{},`${sp.from} → ${sp.to}`),el('td',{},sp.qty),el('td',{},sp.shipCost),el('td',{},sp.departedAt||''),el('td',{},sp.arrivedAt||''),el('td',{},el('button',{class:'btn outline',onclick:async()=>{const d=prompt('Arrival date YYYY-MM-DD');if(!d)return;await api('/api/shipments/'+sp.id,{method:'PUT',body:JSON.stringify({arrivedAt:d})});alert('Marked');render();}},'Mark Arrived')),el('td',{},el('button',{class:'btn outline',onclick:async()=>{if(!confirm('Delete?'))return;await api('/api/shipments/'+sp.id,{method:'DELETE'});render();}},'Delete'))))); const table=el('table',{class:'table'},el('thead',{},el('tr',{},'ID Product From→To Qty ShipCost Departed Arrived Actions'.split(' ').map(h=>el('th',{},h)))),tbody); const form=el('div',{class:'row'},selectProduct('spProduct'),selectCountries('spFrom'),selectCountries('spTo'),inputNumber('spQty','Qty'),inputNumber('spCost','Ship cost'),inputDate('spDepart'),el('button',{class:'btn',onclick:async()=>{const payload={productId:document.getElementById('spProduct').value,fromCountry:document.getElementById('spFrom').value,toCountry:document.getElementById('spTo').value,qty:+document.getElementById('spQty').value||0,shipCost:+document.getElementById('spCost').value||0,departedAt:document.getElementById('spDepart').value};await api('/api/shipments',{method:'POST',body:JSON.stringify(payload)});render();}},'Add Shipment')); return section(title,el('div',{},form,el('div',{style:'height:8px'},''),table));}
async function viewHome(c){const kpi=el('div',{class:'grid'},cardKPI('Products',state.products.length),cardKPI('Warehouses (countries)',state.countries.length),cardKPI('Transit Shipments',(await api('/api/shipments')).shipments.length),cardKPI('Ad Spend (selected)','Use filters')); c.appendChild(section('Overview',kpi)); const cw=await api('/api/deliveries/current-week'); const table=el('table',{class:'table'},el('thead',{},el('tr',{},el('th',{},'Date'),el('th',{},'Day'),el('th',{},'Delivered (all countries)'))),el('tbody',{},...Object.entries(cw.days).map(([d,v])=>{const day=new Date(d).toLocaleDateString(undefined,{weekday:'long'});return el('tr',{},el('td',{},d),el('td',{},day),el('td',{},String(v)))}))); const addForm=el('div',{class:'row'},inputDate('delivDate'),selectCountries('delivCountry'),inputNumber('delivCount','Delivered'),el('button',{class:'btn',onclick:async()=>{const date=document.getElementById('delivDate').value;const country=document.getElementById('delivCountry').value;const delivered=+document.getElementById('delivCount').value||0;if(!date||!country) return alert('Pick date and country');await api('/api/deliveries',{method:'POST',body:JSON.stringify({date,country,delivered})});render();}},'Add delivered')); c.appendChild(section('Daily Delivered (auto Monday reset view)',el('div',{},addForm,el('div',{style:'height:8px'},''),table))); const adForm=el('div',{class:'row'},inputDate('adDate'),selectPlatform('adPlatform'),selectProduct('adProduct'),selectCountries('adCountry'),inputNumber('adAmount','Amount (USD)'),el('button',{class:'btn',onclick:async()=>{const payload={date:document.getElementById('adDate').value,platform:document.getElementById('adPlatform').value,productId:document.getElementById('adProduct').value,country:document.getElementById('adCountry').value,amount:+document.getElementById('adAmount').value||0}; if(!payload.date||!payload.platform||!payload.productId||!payload.country) return alert('Fill all fields'); await api('/api/adspend',{method:'POST',body:JSON.stringify(payload)}); alert('Saved');}},'Add / Replace Ad Spend')); c.appendChild(section('Daily Advertising Spend',adForm)); c.appendChild(await shipmentsSection('China → Kenya','china-kenya')); c.appendChild(await shipmentsSection('Inter-country Shipments','intercountry')); c.appendChild(section('To‑Do List',todo())); c.appendChild(section('Weekly To‑Do',weekly())); }
function todo(){const key='todos'; const items=JSON.parse(localStorage.getItem(key)||'[]'); const box=el('div',{},el('div',{class:'flex'},el('input',{id:'todo',class:'input',placeholder:'Task'}),el('button',{class:'btn',onclick:()=>{const t=document.getElementById('todo').value.trim(); if(!t) return; items.push({id:Math.random().toString(36).slice(2),text:t,done:false}); localStorage.setItem(key,JSON.stringify(items)); render();}},'Add')), ...items.map(it=>el('div',{class:'flex'},el('span',{},it.done?'✅ '+it.text:it.text),el('button',{class:'btn outline',onclick:()=>{it.done=!it.done;localStorage.setItem(key,JSON.stringify(items));render();}},it.done?'Undo':'Done'),el('button',{class:'btn outline',onclick:()=>{const i=items.findIndex(x=>x.id===it.id); items.splice(i,1); localStorage.setItem(key,JSON.stringify(items)); render();}},'Delete')))); return box;}
function weekly(){const key='weeklyTodos'; const data=JSON.parse(localStorage.getItem(key)||'{}'); const days=['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday']; const wrap=el('div',{class:'grid'}); days.forEach(day=>{const items=data[day]||[]; wrap.appendChild(el('div',{class:'card'},el('div',{class:'h'},day),el('div',{class:'flex'},el('input',{id:'w_'+day,class:'input',placeholder:'Task'}),el('button',{class:'btn',onclick:()=>{const t=document.getElementById('w_'+day).value.trim(); if(!t)return; items.push({id:Math.random().toString(36).slice(2),text:t,done:false}); data[day]=items; localStorage.setItem(key,JSON.stringify(data)); render();}},'Add')), ...items.map(it=>el('div',{class:'flex'},el('span',{},it.done?'✅ '+it.text:it.text),el('button',{class:'btn outline',onclick:()=>{it.done=!it.done;data[day]=items;localStorage.setItem(key,JSON.stringify(data));render();}},it.done?'Undo':'Done'),el('button',{class:'btn outline',onclick:()=>{const i=items.findIndex(x=>x.id===it.id); items.splice(i,1); data[day]=items; localStorage.setItem(key,JSON.stringify(data)); render();}},'Delete')))));}); return wrap;}
async function viewProducts(c){const form=el('div',{class:'row'},el('input',{id:'pName',class:'input',placeholder:'Product name'}),el('input',{id:'pSku',class:'input',placeholder:'SKU'}),el('input',{id:'pCost',class:'input',type:'number',placeholder:'Cost China USD'}),el('input',{id:'pShip',class:'input',type:'number',placeholder:'Ship China→Kenya USD'}),el('input',{id:'pMB',class:'input',type:'number',placeholder:'Profit + Ads USD'}),el('button',{class:'btn',onclick:async()=>{const payload={name:document.getElementById('pName').value,sku:document.getElementById('pSku').value,cost_china:+document.getElementById('pCost').value||0,ship_china_to_kenya:+document.getElementById('pShip').value||0,margin_budget:+document.getElementById('pMB').value||0}; await api('/api/products',{method:'POST',body:JSON.stringify(payload)}); await loadProducts(); render();}},'Add Product')); c.appendChild(section('Add Product',form)); const res=await api('/api/products'); const table=el('table',{class:'table'},el('thead',{},el('tr',{},el('th',{},'Name'),el('th',{},'SKU'),el('th',{},'Status'),el('th',{},'Actions'))),el('tbody',{},...res.products.map(p=>el('tr',{},el('td',{},p.name),el('td',{},p.sku||'-'),el('td',{},el('span',{class:'badge'},p.status||'active')),el('td',{},el('button',{class:'btn outline',onclick:async()=>{const ns=p.status==='active'?'paused':'active'; await api('/api/products/'+p.id+'/status',{method:'POST',body:JSON.stringify({status:ns})}); await loadProducts(); render();}},p.status==='active'?'Pause':'Run'), ' ', el('button',{class:'btn outline',onclick:()=>alert('Product page can be extended next')},'Open'), ' ', el('button',{class:'btn outline',onclick:async()=>{if(!confirm('Delete product?'))return; await api('/api/products/'+p.id,{method:'DELETE'}); await loadProducts(); render();}},'Delete')))))); c.appendChild(section('Products',table));}
async function viewPerformance(c){const filter=el('div',{class:'row'},inputDate('pfStart'),inputDate('pfEnd'),selectCountries('pfCountry'),el('button',{class:'btn',onclick:()=>render()},'Run')); c.appendChild(section('Top Delivered Products',filter)); const s=document.getElementById('pfStart')?.value,e=document.getElementById('pfEnd')?.value,cnty=document.getElementById('pfCountry')?.value; if(s&&e){const r=await api(`/api/performance/top-delivered?start=${s}&end=${e}&country=${cnty||''}`); const table=el('table',{class:'table'},el('thead',{},el('tr',{},'Product Pieces AdSpend ProductCost Profit Profit/Piece'.split(' ').map(h=>el('th',{},h)))),el('tbody',{},...r.items.map(it=>el('tr',{},el('td',{},it.productName),el('td',{},it.pieces),el('td',{},it.adSpend.toFixed(2)),el('td',{},it.productCost.toFixed(2)),el('td',{},it.profit.toFixed(2)),el('td',{},it.profitPerPiece.toFixed(2)))))); c.appendChild(section('Results',table)); } const rem=el('div',{class:'row'},inputDate('rStart'),inputDate('rEnd'),selectCountries('rCountry'),selectProduct('rProduct'),inputNumber('rOrders','Orders'),inputNumber('rPieces','Pieces'),inputNumber('rRev','Revenue USD'),inputNumber('rAds','Ad Spend USD'),inputNumber('rCPD','Cost/Delivery USD'),el('button',{class:'btn',onclick:async()=>{const payload={start:document.getElementById('rStart').value,end:document.getElementById('rEnd').value,country:document.getElementById('rCountry').value,productId:document.getElementById('rProduct').value,orders:+document.getElementById('rOrders').value||0,pieces:+document.getElementById('rPieces').value||0,revenue:+document.getElementById('rRev').value||0,adSpend:+document.getElementById('rAds').value||0,costPerDelivery:+document.getElementById('rCPD').value||0}; if(!payload.start||!payload.end) return alert('Select dates'); await api('/api/remittances',{method:'POST',body:JSON.stringify(payload)}); alert('Saved');}},'Add Remittance')); c.appendChild(section('Remittance Report',rem));}
async function viewFinance(c){const cats=await api('/api/finance/categories'); const add=el('div',{class:'row'},el('select',{id:'fcType',class:'select'},el('option',{value:'debit'},'Debit'),el('option',{value:'credit'},'Credit')),el('input',{id:'fcName',class:'input',placeholder:'Category name'}),el('button',{class:'btn',onclick:async()=>{await api('/api/finance/categories',{method:'POST',body:JSON.stringify({type:document.getElementById('fcType').value,name:document.getElementById('fcName').value})}); render();}},'Add Category')); c.appendChild(section('Categories',el('div',{},add,el('div',{style:'height:8px'}),el('div',{},'Debits: '+cats.debits.join(', ')),el('div',{},'Credits: '+cats.credits.join(', '))))); const entry=el('div',{class:'row'},inputDate('feDate'),el('select',{id:'feType',class:'select'},el('option',{value:'debit'},'Debit'),el('option',{value:'credit'},'Credit')),el('input',{id:'feCat',class:'input',placeholder:'Category'}),inputNumber('feAmt','Amount'),el('input',{id:'feNote',class:'input',placeholder:'Note'}),el('button',{class:'btn',onclick:async()=>{const payload={date:document.getElementById('feDate').value,type:document.getElementById('feType').value,category:document.getElementById('feCat').value,amount:+document.getElementById('feAmt').value||0,note:document.getElementById('feNote').value}; await api('/api/finance/entries',{method:'POST',body:JSON.stringify(payload)}); render();}},'Add Entry')); c.appendChild(section('Add Finance Entry',entry)); const q=el('div',{class:'row'},inputDate('fes'),inputDate('fee'),el('input',{id:'fef',class:'input',placeholder:'Categories CSV'}),el('button',{class:'btn',onclick:()=>render()},'Run')); c.appendChild(section('Report Filter',q)); const s=document.getElementById('fes')?.value,e=document.getElementById('fee')?.value,cc=document.getElementById('fef')?.value; if(s&&e){const res=await api(`/api/finance/entries?start=${s}&end=${e}&categories=${encodeURIComponent(cc||'')}`); const table=el('table',{class:'table'},el('thead',{},el('tr',{},'Date Type Category Amount Note'.split(' ').map(h=>el('th',{},h)))),el('tbody',{},...res.entries.map(it=>el('tr',{},el('td',{},it.date),el('td',{},it.type),el('td',{},it.category),el('td',{},it.amount),el('td',{},it.note))))); c.appendChild(section(`Balance: ${res.balance.toFixed(2)} USD`,table)); }}
async function viewSettings(c){const add=el('div',{class:'row'},el('input',{id:'cty',class:'input',placeholder:'Country name'}),el('button',{class:'btn',onclick:async()=>{await api('/api/countries',{method:'POST',body:JSON.stringify({name:document.getElementById('cty').value})}); state.countries=(await api('/api/countries')).countries; render();}},'Add Country')); const tags=el('div',{},...state.countries.map(cn=>el('span',{class:'badge',style:'margin-right:6px'},cn))); c.appendChild(section('Countries',el('div',{},add,el('div',{style:'height:8px'},''),tags))); const rs=el('div',{class:'flex'},...['10m','1h','24h','3d'].map(w=>el('button',{class:'btn outline',onclick:async()=>{try{const r=await api('/api/restore',{method:'POST',body:JSON.stringify({window:w})}); alert('Restored from '+r.restoredFrom); render();}catch(e){alert('No snapshot in window');}}},w))); c.appendChild(section('Restore System',rs));}
async function loginFlow(){const app=document.getElementById('app'); app.innerHTML=''; const box=el('div',{class:'login section'},el('h2',{},'Enter password'),el('input',{class:'input',type:'password',placeholder:'Password',id:'pw'}),el('div',{class:'flex'},el('button',{class:'btn',onclick:async()=>{const pw=document.getElementById('pw').value; try{await api('/api/auth',{method:'POST',body:JSON.stringify({password:pw})}); await ensureAuth(); render();}catch(e){alert('Wrong password')}}},'Login')),el('div',{class:'small'},'Access is remembered per IP.')); app.appendChild(box);}
async function render(){const app=document.getElementById('app'); if(!state.authed) return loginFlow(); app.innerHTML=''; app.appendChild(header()); const c=el('div',{class:'container'}); if(state.view==='home') await viewHome(c); else if(state.view==='products') await viewProducts(c); else if(state.view==='performance') await viewPerformance(c); else if(state.view==='finance') await viewFinance(c); else if(state.view==='settings') await viewSettings(c); app.appendChild(c);}
ensureAuth().then(render);
